# XV6
faild, because Milk-V have no U mode support.
## DuoS Boot Flow
```
┌──────────────────────────┐
│          ROM             │
│  (Mask ROM, SoC code)    │
└─────────────┬────────────┘
              │ loads FSBL
              ▼
┌──────────────────────────┐
│           FSBL           │
│ (First Stage Bootloader) │
│ - Parses boot.sd         │
│ - Loads fip.bin          │
└─────────────┬────────────┘
              │ loads FIP
              ▼
┌──────────────────────────┐
│          FIP.bin         │
│  (Firmware Image Package)│
│  Contains:               │
│   • BL2 / BL31 (ATF)     │
│   • OpenSBI (M-mode)     │
│   • Kernel payload       │
└─────────────┬────────────┘
              │ jumps to
              ▼
┌──────────────────────────┐
│          OpenSBI         │
│     (M-mode runtime)     │
│  Sets up SBI environment │
│  Passes control to next  │
└─────────────┬────────────┘
              │ loads payload
              ▼
┌──────────────────────────┐
│      Kernel Payload      │
│ (Linux kernel or xv6)    │
└─────────────┬────────────┘
              │ enters OS
              ▼
┌──────────────────────────┐
│      Operating System    │
│ (Linux userland or xv6)  │
└──────────────────────────┘
```
## linux image
```bash
robin@mbp ~  % diskutil list
......
/dev/disk8 (internal, physical):
   #:                       TYPE NAME                    SIZE       IDENTIFIER
   0:     FDisk_partition_scheme                        *15.7 GB    disk8
   1:             Windows_FAT_32 boot                    134.2 MB   disk8s1
   2:                      Linux                         805.3 MB   disk8s3
                    (free space)                         14.8 GB    -

robin@mbp ~  % ls /Volumes 
Macintosh HD	boot
robin@mbp ~  % ls /Volumes/boot 
boot.sd	fip.bin
```
- boot.sd : First Stage Bootloader script
- fip.bin  : Firmware Image Package 

## edit fip.bin
#### docker
```bash
docker -v
Docker version 29.0.0, build 3d4129b9ea
```
#### [Compiled using Docker](https://github.com/milkv-duo/duo-buildroot-sdk)
```bash
git clone https://github.com/milkv-duo/duo-buildroot-sdk.git --depth=1
```

## make xv6
```bash
make clean
make
```










## make image
##### install tools
```bash
brew install u-boot-tools
mkimage -V
```

##### vi boot.cmd
```shell
echo "Booting xv6"

fatload mmc 0:1 0x80200000 kernel
go 0x80200000
```

##### script boot.scr
```bash
mkimage -A riscv -T script -C none -d boot.cmd boot.scr

Image Name:   
Created:      Thu Dec 11 11:46:06 2025
Image Type:   RISC-V Linux Script (uncompressed)
Data Size:    75 Bytes = 0.07 KiB = 0.00 MiB
Load Address: 00000000
Entry Point:  00000000
Contents:
   Image 0: 67 Bytes = 0.07 KiB = 0.00 MiB

robin@mbp xv6 master % ls -lh boot.scr 
-rw-r--r--@ 1 robin  staff   139B Dec 11 11:46 boot.scr
```

##### check disk
```bash
diskutil list
/dev/disk8 (internal, physical):
......
```

##### eraseDisk & MBR format FAT32
```shell
diskutil eraseDisk FAT32 XV6 MBRFormat /dev/disk8
Started erase on disk8
Unmounting disk
Creating the partition map
Waiting for partitions to activate
Formatting disk8s1 as MS-DOS (FAT32) with name XV6
1024 bytes per physical sector
/dev/rdisk8s1: 247901 sectors in 247901 FAT32 clusters (512 bytes/cluster)
bps=512 spc=1 res=32 nft=2 mid=0xf8 spt=32 hds=16 hid=95 drv=0x80 bsec=251809 bspf=1938 rdcl=2 infs=1 bkbs=6
Mounting disk
Finished erase on disk8

robin@mbp xv6 master % diskutil list disk8                              
/dev/disk8 (internal, physical):
   #:                       TYPE NAME                    SIZE       IDENTIFIER
   0:     FDisk_partition_scheme                        *129.0 MB   disk8
   1:                 DOS_FAT_32 XV6                     128.9 MB   disk8s1
```

##### /Volumes/XV6
```bash
robin@mbp xv6 master % ls /Volumes 
Macintosh HD    XV6

cp kernel /Volumes/XV6/
cp boot.scr /Volumes/XV6/
cp fs.img /Volumes/XV6/

ls -lh /Volumes/XV6 
total 4559
-rwx------@ 1 robin  staff   139B Dec 11 12:04 boot.scr
-rwx------@ 1 robin  staff   2.0M Dec 11 12:06 fs.img
-rwx------@ 1 robin  staff   279K Dec 11 12:06 kernel

diskutil eject /dev/disk8
```